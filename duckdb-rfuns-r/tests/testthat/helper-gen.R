convert_arg <- function(arg) {
  if (is.call(arg)) stop("not supported yet, will deal with special cases later")
  arg
}

# TODO: this should live in the package somewhere
udfs <- c(
  "==" = "r_base::==",
  "+"  = "r_base::+"
)

convert_expr <- function(expr) {
  fun <- as.character(rlang::node_car(expr))

  args <- as.list(expr[-1])
  args <- lapply(args, convert_arg)
  names(args) <- paste0("x", seq_along(args))

  list(fun = fun, udf = udfs[[fun]], data = tibble::as_tibble(args), expression = deparse(expr))
}

gen_dir <- file.path("tests", "testthat", "gen")
gen_files <- list.files(gen_dir, pattern = "[.][rR]$")

for (f in gen_files) {
  test_file <- file(file.path("tests", "testthat", paste0("test-generated-", f)), open = "w")
  cat("# Generated by helper-gen.R: do not edit by hand\n", file = test_file)

  expressions <- parse(file.path(gen_dir, f))
  header <- sapply(expressions, is.character)
  group <- cumsum(header)

  description <- as.character(expressions[header])
  for (i in seq_along(description)) {
    desc <- description[[i]]

    cat(glue::glue((r"[test_that('{desc}', ]")), file = test_file)
    cat("{\n", file = test_file)
    cat("  con <- local_con()\n", file = test_file)

    exprs <- lapply(tail(expressions[group == i], -1), convert_expr)

    for (expr in exprs) {
      cat("  # ", expr$expression, "\n", file = test_file)
      cat("  in_df <- ", file = test_file)
      cat(constructive::construct(expr$data)$code, file = test_file, sep = "\n")
      cat("  in_rel <- duckdb:::rel_from_df(con, in_df)\n", file = test_file)

      cat("  out_rel <- duckdb:::rel_project(in_rel,\n", file = test_file)
      cat("      list(duckdb:::expr_function(\n", file = test_file)
      cat(paste0("        '", expr$udf, "', \n        list(\n"), file = test_file)
      cat(paste(paste0("          duckdb:::expr_reference('", names(expr$data), "')"), collapse = ",\n"), file = test_file)
      cat("\n", file = test_file)
      cat("        )\n", file = test_file)
      cat("      ))\n", file = test_file)
      cat("  )\n", file = test_file)
      cat("  out_df <- duckdb:::rel_to_altrep(out_rel)\n", file = test_file)
      cat("  expect_snapshot(out_df)\n\n\n", file = test_file)
    }

    cat("})\n\n", file = test_file)

  }

  close(test_file)
}

